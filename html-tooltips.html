<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Plain JS Tooltip (HTML content, top/bottom)</title>
    <style>
        :root {
            --arrow-x: 10px;
        }
        /* Basic page demo styling */
        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            line-height: 1.4;
            padding: 40px;
        }

        h1 {
            font-size: 20px;
            margin-bottom: 12px;
        }

        .demo-row {
            display: flex;
            gap: 18px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Tooltip styles */
        .tooltip-portal {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
        }

        .tooltip {
            --bg: #0f172a;
            --fg: #eef2ff;
            --shadow: 0 8px 20px rgba(2, 6, 23, 0.45);
            position: fixed; /* KEY: use fixed so coordinates are viewport-based */
            max-width: 320px;
            padding: 10px 12px;
            border-radius: 8px;
            background: var(--bg);
            color: var(--fg);
            box-shadow: var(--shadow);
            font-size: 13px;
            line-height: 1.35;
            z-index: 9999;
            transform-origin: center;
            opacity: 0;
            transform: translateY(6px) scale(0.98);
            transition: opacity 160ms ease, transform 160ms ease;
            pointer-events: auto; /* allow hovering the tooltip */
            left: 0;
            top: 0;
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .tooltip .inner {
            max-height: 60vh;
            overflow: auto;
        }

        /* Arrow - use CSS variable to position horizontally */
        .tooltip::after {
            content: "";
            position: absolute;
            left: var(--arrow-x, 50%);
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: var(--bg);
            box-shadow: var(--shadow);
            clip-path: polygon(50% 0, 0 100%, 100% 100%); /* triangle */
        }

        .tooltip.top::after {
            bottom: -6px;
            transform: translateX(-50%) rotate(180deg);
        }

        .tooltip.bottom::after {
            top: -6px;
            transform: translateX(-50%);
        }

        /* Example trigger styling */
        .has-tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        button.has-tooltip {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background: white;
        }

        /* Code block inside tooltip */
        .tooltip pre {
            margin: 0;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
            font-size: 12px;
            overflow: auto;
            background: transparent;
        }

        /* Responsive small-screen adjustments */
        @media (max-width: 420px) {
            .tooltip {
                max-width: 92vw;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
<h1>Plain JS Tooltip — HTML content, auto top/bottom</h1>

<p>Hover or focus the items to see the tooltip. The tooltip content can contain markup (HTML) — examples below include a
    small styled code block.</p>

<div class="demo-row" style="margin-top: 18px;">
    <button class="has-tooltip" data-tooltip-id="tt1">Hover me (code)</button>

    <span class="has-tooltip" data-tooltip-id="tt2" tabindex="0">Inline element</span>

    <button class="has-tooltip" data-tooltip-id="tt3" style="margin-left: 18px;">Long HTML content</button>
</div>

<!-- Tooltip contents (kept in DOM but not visible). These can be anywhere -->
<div id="tooltip-contents" style="display:none">
    <div id="tt1">
        <div style="font-weight:600; margin-bottom:6px;">Example code</div>
        <pre><code>&lt;div class="card"&gt;Hello&lt;/div&gt;</code></pre>
    </div>

    <div id="tt2">
        <strong>HTML allowed</strong>
        <div>Use <em>markup</em>, links: <a href="#">example</a>, lists:</div>
        <ul style="padding-left:16px;margin:6px 0 0 0">
            <li>Item A</li>
            <li>Item B</li>
        </ul>
    </div>

    <div id="tt3">
        <div style="font-size:13px; font-weight:600; margin-bottom:6px">Long content</div>
        <div>This tooltip contains a longer block of HTML including a small code sample and a paragraph to demonstrate
            automatic switching between top/bottom positioning depending on available space.
        </div>
        <pre style="margin-top:8px"><code>function greet(name) {
  return `Hello ${name}`
}</code></pre>
    </div>
</div>

<!-- Portal where the tooltip DOM will be appended so it can escape overflow/stacking contexts -->
<div id="tooltip-portal" class="tooltip-portal" aria-hidden="true"></div>

<script>
    /* Improved tooltip positioning (fixed coords, more robust measurement and placement) */
    (function () {
        const portal = document.getElementById('tooltip-portal');
        const contentsRoot = document.getElementById('tooltip-contents');

        if (!portal) throw new Error('Missing tooltip portal in DOM');

        let active = null; // {trigger, tooltipEl, contentEl}
        let idCounter = 0;

        function createTooltipElement() {
            const el = document.createElement('div');
            el.className = 'tooltip';
            el.setAttribute('role', 'tooltip');
            el.setAttribute('aria-hidden', 'true');
            el.style.left = '0px';
            el.style.top = '0px';
            el.innerHTML = '<div class="inner"></div>';
            portal.appendChild(el);
            return el;
        }

        function showTooltip(trigger, contentEl) {
            hideTooltip(); // one tooltip at a time

            const tooltipEl = createTooltipElement();
            const inner = tooltipEl.querySelector('.inner');
            inner.appendChild(contentEl.cloneNode(true));

            tooltipEl.id = 'tooltip-' + (++idCounter);

            const prevDesc = trigger.getAttribute('aria-describedby');
            trigger.setAttribute('aria-describedby', tooltipEl.id);

            active = {trigger, tooltipEl, contentEl, prevDesc};

            // position immediately, then show
            positionTooltip();

            // show after positioning (avoid jumpy measure due to transitions)
            requestAnimationFrame(() => {
                tooltipEl.classList.add('show');
                tooltipEl.setAttribute('aria-hidden', 'false');
            });

            // event listeners
            window.addEventListener('scroll', positionTooltip, true);
            window.addEventListener('resize', positionTooltip);
            document.addEventListener('keydown', onDocKeyDown);
        }

        function hideTooltip() {
            if (!active) return;
            const {trigger, tooltipEl, prevDesc} = active;
            tooltipEl.classList.remove('show');
            tooltipEl.setAttribute('aria-hidden', 'true');

            // remove after transition
            tooltipEl.addEventListener('transitionend', () => {
                if (tooltipEl.parentNode) tooltipEl.parentNode.removeChild(tooltipEl);
            }, {once: true});

            // restore aria-describedby
            if (prevDesc !== null) {
                if (prevDesc) trigger.setAttribute('aria-describedby', prevDesc);
                else trigger.removeAttribute('aria-describedby');
            }

            active = null;
            window.removeEventListener('scroll', positionTooltip, true);
            window.removeEventListener('resize', positionTooltip);
            document.removeEventListener('keydown', onDocKeyDown);
        }

        function onDocKeyDown(e) {
            if (!active) return;
            if (e.key === 'Escape') hideTooltip();
        }

        function positionTooltip() {
            if (!active) return;
            const {trigger, tooltipEl} = active;

            const rect = trigger.getBoundingClientRect();

            // Prepare tooltip for measurement: make it visible but hidden to avoid reflows due to transitions
            tooltipEl.style.visibility = 'hidden';
            tooltipEl.classList.remove('show');

            // Force browser to layout and get size
            const ttRect = tooltipEl.getBoundingClientRect();

            const margin = 8;
            const spaceAbove = rect.top;
            const spaceBelow = window.innerHeight - rect.bottom;

            const fitAbove = ttRect.height + margin <= spaceAbove;
            const fitBelow = ttRect.height + margin <= spaceBelow;

            let placeTop = false;
            if (fitAbove && !fitBelow) placeTop = true;
            else if (!fitAbove && fitBelow) placeTop = false;
            else {
                // both fit or both don't: prefer the side with more space
                placeTop = spaceAbove > spaceBelow;
            }

            // horizontal centering but clamped
            const centerX = rect.left + rect.width / 2;
            let left = centerX - ttRect.width / 2;
            const minLeft = 6;
            const maxLeft = window.innerWidth - ttRect.width - 6;
            left = Math.max(minLeft, Math.min(maxLeft, left));

            let top;
            if (placeTop) {
                top = rect.top - ttRect.height - margin;
                tooltipEl.classList.remove('bottom');
                tooltipEl.classList.add('top');
                tooltipEl.setAttribute('data-position', 'top');
            } else {
                top = rect.bottom + margin;
                tooltipEl.classList.remove('top');
                tooltipEl.classList.add('bottom');
                tooltipEl.setAttribute('data-position', 'bottom');
            }

            // Apply position using viewport (fixed) coords
            tooltipEl.style.left = Math.round(left) + 'px';
            tooltipEl.style.top = Math.round(top) + 'px';

            // arrow horizontal position (percentage)
            const triggerCenterInTooltip = centerX - left;
            const percent = (triggerCenterInTooltip / ttRect.width) * 100;
            const clamped = Math.max(8, Math.min(92, percent));
            tooltipEl.style.setProperty('--arrow-x', clamped + '%');

            // restore visibility (but keep 'show' class off — show() will add it)
            tooltipEl.style.visibility = '';
        }

        // Attach event listeners to triggers
        function init() {
            const triggers = document.querySelectorAll('.has-tooltip[data-tooltip-id]');
            triggers.forEach(t => {
                const id = t.getAttribute('data-tooltip-id');
                const content = document.getElementById(id);
                if (!content) return;

                // mouse events
                t.addEventListener('mouseenter', () => showTooltip(t, content));
                t.addEventListener('mouseleave', (e) => {
                    // if moving into tooltip, don't hide
                    const to = e.relatedTarget;
                    if (to && portal.contains(to)) return;
                    hideTooltip();
                });

                // focus/blur for keyboard
                t.addEventListener('focus', () => showTooltip(t, content));
                t.addEventListener('blur', () => hideTooltip());

                // allow moving the mouse into the tooltip without it disappearing
                portal.addEventListener('mouseenter', (e) => {
                    // noop — keep tooltip open
                });

                portal.addEventListener('mouseleave', (e) => {
                    const to = e.relatedTarget;
                    // small timeout to allow enter into trigger
                    setTimeout(() => {
                        if (!active) return;
                        const {trigger} = active;
                        if (to === trigger) return;
                        hideTooltip();
                    }, 50);
                });
            });
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
        else init();

        window.__Tooltip = {showTooltip, hideTooltip};
    })();
</script>
</body>
</html>