<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart</title>
    <link rel="stylesheet" href="css/style.css" type="text/css">
    <link rel="stylesheet" href="css/chart.css">
</head>

<div class="main-header">
    <div class="open-menu"></div>
    <div class="last">
        <div class="darkmode-picker cursor-pointer">
            <div id="theme-toggle" class="theme-toggle flex" aria-label="Toggle dark mode">
                <span id="theme-icon" class="icon icon-light"></span>
            </div>
        </div>
    </div>
</div>


<div class="content push-content">
    <div class="row">
        <div class="column">
            <h3>T Werte / Prozentrang</h3>
            <div class="switch">
                <input type="checkbox" id="switch"/><label for="switch">T Werte</label>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="column card input-values">
            <label for="input-alltagswissen">Alltagswissen</label>
            <input id="input-alltagswissen" type="number">
        </div>
        <div class="column grow-2"></div>
    </div>
    <div class="row">
        <div id="chart-container" class="column card"></div>
    </div>

</div>

<script src="js/chart.js"></script>
<script type="module">
    import {utils} from "./js/utils.js";
    const data = [
        {id: 1, position: 1, name: 'Alltagswissen', value: 41},
        {id: 2, position: 2, name: 'Realitätssicherheit', value: 48},
        {id: 3, position: 3, name: 'Angewandtes Rechnen', value: 59},
        {id: 4, position: 4, name: 'Soziale und Sachliche Folgerichtigkeit', value: 44},
        {id: 5, position: 5, name: 'Unmittelbares Reproduzieren - numerisch', description: 'vorwärts', value: 46},
        {id: 6, position: 5, name: 'Unmittelbares Reproduzieren - numerisch', description: 'rückwärts', value: 41},
        {id: 7, position: 6, name: 'Synonyme Finden', value: 48},
        {id: 8, position: 7, name: 'Kodieren und Assoziieren', description: 'Kodiermenge', value: 48},
        {id: 9, position: 7, name: 'Kodieren und Assoziieren', description: 'Assoziationen', value: 54},
        {id: 10, position: 8, name: 'Antizipieren und Kombinieren - figural', value: 38},
        {id: 11, position: 9, name: 'Funktionen Abstrahieren', value: 42},
        {id: 12, position: 10, name: 'Analysieren und Synthetisieren - abstrakt', value: 43},
        {id: 13, position: 11, name: 'Soziales Erfassen und Sachliches Reflektieren', value: 45},
        {id: 14, position: 12, name: 'Formale Folgerichtigkeit', value: 47},
    ];

    // Initialize Chart
    utils.ready(function () {
        window.chart = new Chart('chart-container', data);
        window.chart.render();
        let switchState = false;

        document.getElementById('input-alltagswissen').addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                event.preventDefault(); // optional: prevents form submit
                handleInputChange(1, this.value);
            }
        });
        document.getElementById('input-alltagswissen').addEventListener("blur", function () {
            handleInputChange(1, this.value);
        });
        document.getElementById('switch').addEventListener('change', function () {
            document.querySelector("label[for='switch']").textContent = this.checked ? 'Prozentrang' : 'T Werte';
            switchState = this.checked;

            document.querySelectorAll('.input-values input').forEach(input => {
                if (switchState) {
                    console.log('nach prozent');
                    input.value = tWertZuProzentrang(input.value);
                } else {
                    console.log('nach t wert');
                    input.value = prozentrangZuTWert(input.value);
                }
            });
        });

        function handleInputChange(row, value) {
            console.log(switchState);

            let tValue = switchState ? prozentrangZuTWert(value) : value;
            console.log(tValue);
            console.log(Math.round(tValue));
            console.log(value);
            chart.updateRowValue(row, Math.round(tValue));
        }
    });

    function tWertZuProzentrang(t) {
        // Umrechnung T-Wert -> z-Wert
        const z = (t - 50) / 10;

        // Fehlerfunktion (erf) – Näherung
        function erf(x) {
            const a1 = 0.254829592;
            const a2 = -0.284496736;
            const a3 = 1.421413741;
            const a4 = -1.453152027;
            const a5 = 1.061405429;
            const p = 0.3275911;

            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x);

            const t = 1 / (1 + p * x);
            const y =
                1 -
                (((((a5 * t + a4) * t + a3) * t + a2) * t + a1) *
                    t *
                    Math.exp(-x * x));

            return sign * y;
        }

        // Standardnormalverteilung (CDF)
        const percentile = 0.5 * (1 + erf(z / Math.sqrt(2)));

        // In Prozent (0–100)
        return Math.round(percentile * 10000) / 100; // auf 2 Dezimalstellen
    }

    function prozentrangZuTWert(p) {
        // p als Prozent (0–100)
        const pr = p / 100;

        // Inverse Normalverteilung (Acklam-Approximation)
        function normInv(p) {
            const a1 = -39.6968302866538;
            const a2 = 220.946098424521;
            const a3 = -275.928510446969;
            const a4 = 138.357751867269;
            const a5 = -30.6647980661472;
            const a6 = 2.50662827745924;

            const b1 = -54.4760987982241;
            const b2 = 161.585836858041;
            const b3 = -155.698979859887;
            const b4 = 66.8013118877197;
            const b5 = -13.2806815528857;

            const c1 = -0.00778489400243029;
            const c2 = -0.322396458041136;
            const c3 = -2.40075827716184;
            const c4 = -2.54973253934373;
            const c5 = 4.37466414146497;
            const c6 = 2.93816398269878;

            const d1 = 0.00778469570904146;
            const d2 = 0.32246712907004;
            const d3 = 2.445134137143;
            const d4 = 3.75440866190742;

            const plow = 0.02425;
            const phigh = 1 - plow;
            let q, r;

            if (p < plow) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) /
                    ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            }

            if (p > phigh) {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) /
                    ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            }

            q = p - 0.5;
            r = q * q;
            return (((((a1 * r + a2) * r + a3) * r + a4) * r + a5) * r + a6) * q /
                (((((b1 * r + b2) * r + b3) * r + b4) * r + b5) * r + 1);
        }

        // z-Wert berechnen
        const z = normInv(pr);

        // z -> T-Wert
        const t = 50 + z * 10;

        return Math.round(t * 100) / 100; // 2 Nachkommastellen
    }
</script>
</body>
</html>